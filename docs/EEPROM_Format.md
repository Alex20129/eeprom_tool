# EEPROM Format

Формат восстановлен методом Реверс-инжиниринга

**Описание формата**\
Формат состоит из трех разделов: 
* Информация об устройстве
* Результаты теста PT1 и PT2 (физическое и функциональное тестирование)
* Sweep, результаты с индивидуальной подстройкой частоты

Размер данных не более 256 байт, вся структура помещается в I2C EEPROM 24C02
Каждый из разделов содержит CRC - циклическую контрольную сумму блока.
Для кодирования данных используется алгоритм [XXTEA](). Кодирование выполняется над Разделами данных кроме первых двух байт, содержащих версию формата и номер ключа шифрования.

**Версии формата**\
Мы обеспечиваем чтение форматов версия v4-v6, которые применяются на AntMiner.

* v5: Добавлен раздел индивидуальной настройки частот Sweep
* v6: Информация о датчиках PIC заменяется на два дополнительных датчика ASIC

### Заголовок. Информация об алгоритме и ключах

Общая информация и версии (General Info & Versions) 
* Eeprom Version: 4, 5, или 6
  - Версия структуры данных в EEPROM. Версия 4 используется для плат серии S19. 

* Algorithm Version: 1 (XXTEA), 2 (XOR scrambler)
  - Версия алгоритма кодирования.

* Key Version: 1 
  - Версия криптографических ключей, которые могут использоваться для кодирования EEPROM
  
### Раздел 1. Идентификация платы и чипов (Board & Chip Info) 

* Board SN: HYDTYNGBAAJAI06BE
  - Уникальный серийный номер хеш-платы. 
* Chip Die: ED 
  - Внутренний код ревизии или типа кристалла ASIC-чипа. 
* Chip Marking: S1CT21CB23 
  - Маркировка, нанесенная непосредственно на корпус 
ASIC-чипа. Помогает идентифицировать конкретную модель и партию чипов. 
* Chip Bin: 3
  - "Бин" чипа — это категория качества, присвоенная чипам на заводе после тестирования. Чипы сортируются по их энергоэффективности и способности 
работать на определенных частотах при определенном напряжении. Чем 
ниже номер "бина", тем качественнее чипы (требуют меньше напряжения 
для стабильной работы). 
  - Значение: 3 — это хороший, стандартный бин для S19. На основе этого 
значения прошивка автоматически подбирает рабочее напряжение. 
  
* Chip Tech: AC 
  - Внутренний код, обозначающий технологический процесс производства чипов. 
* Board Name: BHB42601
  - Внутреннее кодовое название модели хеш-платы. 
* PCB Version: 01.00
  - Версия печатной платы (Printed Circuit Board). Разные ревизии S19 могут иметь незначительные отличия в разводке платы. 
* BOM Version: 00.10
  - Версия спецификации (Bill of Materials). Указывает на конкретный набор электронных компонент (резисторов, конденсаторов, микросхем и т.д.), использованных при сборке печатной платы. 

**Сенсоры и рабочие параметры (Sensors & Operating Parameters)**

* ASIC sensor Type: 0
  - Тип температурных датчиков, подключенных к ASIC или встроенных встроенных в ASIC-чипы. В S19 температура обычно считывается другим методом, встроенные датчики не используются. Значения в этом случае равны нулю. Тип датчиков NCT218
* ASIC sensor Offsets: 0 0 0 0 
  - смещения адресов ASIC для температурных датчиков. В формате v6 предусмотрено до 6-и датчиков.
* PIC sensor Type: 142 (LM75A) 139 (TMP451)
  - Тип I2C- основного температурного датчика на плате, который опрашивается PIC-микроконтроллером.
* PIC sensor Mask: 15
  - Маска I2C адресов термодатчиков подключенных через контроллер PIC. Биты в маске отвечают адресам 0x48...0x4B

* FT Version: F1V05B2C1 
  - Версия программного обеспечения заводского тестового стенда функционального тестирования (Factory Test), на котором проверялась эта плата. 
  - Значение показывает, какой версией теста плата была протестирована на заводе. 
* Factory Job: HYDT20211001003-Y1 
  - Идентификатор производственного задания. Содержит: 
    + HYDT: Код завода-сборщика. 
    + 2021-10-01: Дата производства (1 октября 2021 года). 
    + 003-Y1: Номер партии или смены. 

**Результаты функционального тестирования (PT1)**

* PT1 Result: 1 (PASS)
  - Прохождение теста
* PT1 Count: 1
  - количество циклов тестирования. 

Заметим, функциональное тестирование выполняется на конвейере в процессе монтажа печатной платы без системы охлаждения на низких частотах платы. Прохождение теста означает: Все ASIC-чипы найдены на линии и прошли предварительную настройку. В процессе также выполняется загрузка прошивки PIC контроллера и идентификация термодатчиков.

Для восстановления информации о плате используется _Board Name_. По имени восстанавливается топология платы. см. [примеры топологий плат](../examples/)

### Раздел 2. Результаты заводского тестирования (Production Test 2)**

Заводской тест PT2 выполняется после полной сборки платы, в режиме одна плата или полная сборка (3-4 платы). Раздел содержит условия тестирования и результаты тестирования.

* Voltage: 13.60 
  - Заводское (штатное) напряжение питания платы, при котором выполнялось тестирование. Эталонное напряжение для данной платы. 
* Frequency: 545 
  - Номинальная частота чипов в мегагерцах (МГц). Эталонная (максимальная) частота для данной платы, на которой выполнялся функциональный тест. 
* Nonce Rate: 9997 
  - Показатель нахождения "нонсов" (решений) во время заводского теста. Это не хэшрейт в TH/s, а внутренняя метрика производительности при тестовом задании. При повышении тактовой частоты ядра может наблюдаться снижение числа положительных откликов (решений). Высокое значение (близкое к 10000) говорит о том, что все чипы отработали корректно во время теста. 
* PCB Temp In: 45
* PCB Temp Out: 65
  - Температура печатной платы (в градусах Цельсия) по направлению воздушного потока (на входе и выходе)
* PT2 Result: 1 (PASS)
* PT2 Count: 1 
  - Результат второго производственного теста (Production Test 2) и количество попыток. Значения 1 и 1 говорят, что плата успешно прошла этот этап тестирования с первой попытки. 

### Раздел 3. Индивидуальная настройка частот ASIC-чипов (Sweep Data) 

Раздел может заполняться в процессе эксплуатации (предпродажное продолжительное тестирование), для оптимизации энергопотребления и работоспособности каждого отдельного ASIC-чипа.

* Sweep Hashrate: 9999
  - показатель нахождения решений на базовом тесте.
* Sweep Freq base: 545
* Sweep Freq step: 5
  - базовая частота кодирования (MHz) и шаг дискретизации частоты(MГц).
* Sweep Data: Array 
  - таблица частот

Таблица частот кодируется относительно базовой частоты по формуле

$$
F_i = F_{base} + F_{step}\cdot data[i]
$$

Для хранения отклонений используется 4 бита [0,15] на каждый чип. Смещения для двух ASIC-чипов кодируются в одном байте.

Если таблица Sweep Data заполнена, то после выхода на режим выполняется подстройка частот для достижения оптимального режима каждого чипа. Таблица отражает максимальную частоту каждого отдельного ASIC-чипа.